#!/usr/bin/env bash
set -eu

echo "updating properties"
wd sparql ./scripts/assets/properties.rq --index property > ./scripts/assets/properties.json

# Using printf to avoid getting an undesired newline break
printf "// Generated by scripts/update_properties\nmodule.exports = " > ./lib/properties.js.tmp
./scripts/get_properties_index >> ./lib/properties.js.tmp

which eslint > /dev/null && {
  # If eslint is installed, fix possible indentation inconsistencies
  # to avoid having eslint report them later
  eslint --fix ./lib/properties.js.tmp || echo 'not linting'
} || {
  echo "standard command not found: skipping linting"
}

# Now that risky operations are over, we can cleanup
# with a low risk of crashing and letting empty files behind us
mv ./lib/properties.js.tmp ./lib/properties.js

echo "generating properties index"
./scripts/generate_properties_index

echo "copying the index in the public folder to make it publicly accessible"
cp ./lib/properties_index.js ./public/properties_index.js

echo "generating properties links data"
# Disable requests logs to prevent
# `RangeError [ERR_CHILD_PROCESS_STDIO_MAXBUFFER]: stdout maxBuffer length exceeded`
export HUB_VERBOSE_REQUESTS=false
./scripts/generate_links_data
